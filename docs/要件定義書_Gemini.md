---
tags:
  - dev
---
## アプリケーション要件定義書 (改訂版)

提供された「要求整理.md」「要件定義での質問への回答.md」およびレビュー結果に基づき、開発するアプリケーションの要件を以下に定義します。

### 1. 概要

本ドキュメントは、特定のオーディオサンプルに音色が類似するシンセサイザーのプリセットを検索するアプリケーションの要件を定義するものです。

#### 1.1. 目的と背景

楽曲制作において、オーディオループからMIDIベースの制作へ移行する際に、音色が似たシンセプリセットを探す作業に時間がかかるという課題があります。このプロセスを効率化するため、手持ちのプリセットのプレビュー音源（Preset Preview）の中から、参照したいオーディオサンプル（Target Audio）と音響的に類似するものを高速に検索するシステムを開発します。

#### 1.2. 対象利用者

個人利用を想定しています。

#### 1.3. スコープ

- **IN SCOPE (対象範囲)**
    
    - Target Audioと音色が類似するPreset Previewを検索し、ランキング形式で出力するCLI（コマンドラインインターフェース）アプリケーションの開発。
        
    - 主要な音響特徴量抽出モデルとしてCLAPの利用を検討。
        
    - 将来的に他のモデルへ差し替えられるよう、プラグイン構造を意識したモジュール分割。
        
    - 最低限のエラーハンドリングとログ出力。
        
- **OUT OF SCOPE (対象外)**
    
    - GUI（グラフィカルユーザーインターフェース）。
        
    - 厳密な定量的KPI（Key Performance Indicator）設定。
        
    - CI/CDパイプラインの構築、詳細なモニタリング機能。
        
    - 差分でのインデックス更新機能。
        

### 2. 機能要件

#### 2.1. データ事前準備機能 (インデックス作成)

- ユーザーが所有する多数のPreset Previewファイルから、音響的特徴量を一括で計算（埋め込みベクトルを生成）し、検索インデックスとしてファイルに保存する機能。
    
- Preset Previewが追加された場合の更新は、差分計算ではなく、全件再計算を基本とする。
    

#### 2.2. 類似音声検索機能

- ユーザーが指定した単一のTarget Audioファイルから、同様に特徴量を計算する機能。
    
- 事前準備で作成したインデックスとTarget Audioの特徴量を比較し、コサイン類似度などの手法で類似度を計算する。
    
- 類似度が高い順にPreset Previewを並べ替える。
    

#### 2.3. 入出力要件

##### 2.3.1. CLIインターフェース仕様

- アプリケーションは以下の形式のコマンドライン引数を受け付ける。
    
    - **インデックス作成**: `python main.py index --preset-dir <プリセット音源のディレクトリパス> --output <インデックスファイルの出力パス>`
        
    - **類似検索**: `python main.py search --target <ターゲット音源のパス> --index <インデックスファイルのパス> --top-k <取得件数> --out <CSV結果の出力パス>`
        

##### 2.3.2. CSV出力仕様

- 検索結果のリストをCSV形式で出力する。
    
- **列項目**: `rank` (順位), `file_path` (プリセット音源のフルパス), `similarity_score` (類似度スコア)
    
- **文字コード**: UTF-8
    

### 3. 非機能要件

#### 3.1. 性能要件

- **オンライン性能 (類似検索)**: ユーザーが検索を実行してから結果が出力されるまでの応答時間が、ローカル環境で1分以内に完了すること。ただし、精度を上げる代わりに処理時間が伸びるようなオプションも持てると良い(WANT要件)。
    

#### 3.2. 品質要件

- **評価**: 検索結果の品質は、開発者が主観的なABテストで判断する。
    
- **テスト**: 品質保証のため、最低限の自動テストを導入する。テスト仕様については別途定義する予定。
        

#### 3.3. データ要件

- **Target Audio (入力)**:
    
    - ファイル形式: WAV
        
    - サンプリング周波数: 44.1kHz または 48kHz
        
    - ビット深度: 16bit または 24bit
        
- **Preset Preview (入力)**:
    
    - ファイル形式: OGG
        
    - ファイル数: 約30,000件から、将来的に最大約60,000件
        
- **前処理**:
    
    - 全ての入力音声は、特徴量抽出の前にCLAPモデルが要求する **48kHz, モノラル, WAV形式相当のデータ** に変換する。
        
    - 44.1kHzの入力は48kHzにリサンプリングする。
        
    - OGG形式の入力はデコードする。
        
    - ステレオの入力はモノラルに変換する。
        

#### 3.4. 技術・開発要件

- **主要言語**: Python
    
- **特徴抽出モデル**:
    
    - 初期実装ではCLAPを検討する。
        
    - 将来的に他のモデルへ差し替えられるよう、プラグイン構造を採用する。
        
- **エラーハンドリングとログ**:
    
    - 想定される主要なエラーシナリオでは、エラーメッセージを出力し、非ゼロの終了コードでプロセスを終了する (`exit(1)`)。
        
        - **シナリオ例**: 入力ファイル/ディレクトリの欠損、モデルファイルの読み込み失敗、サポート外のオーディオフォーマットなど。
            
    - ログは以下の3レベルで出力する。
        
        - **INFO**: 処理の開始・終了、処理件数など、正常系の進捗状況。
            
        - **WARNING**: 処理は継続するが、スキップしたファイルがある場合など、ユーザーへの注意喚起。
            
        - **ERROR**: 処理を中断せざるを得ない異常発生時。
            

#### 3.5. 実行環境

- **プラットフォーム**: ローカルのGPU搭載マシン。
    
- **リソース制約**: メモリ32GBを搭載したMacでの実行を想定。GPU VRAMの消費量に留意する。
    

#### 3.6. セキュリティ・ライセンス

- **生成データ**: Preset Previewから生成した埋め込みベクトルは、ライセンス上の問題を避けるため再配布しない。
    
- **依存ライブラリ**: CLAP (CC0-1.0), Faiss (MIT) に加え、OGGデコード等に利用するライブラリ（例: `pydub`やそのバックエンドである`ffmpeg`）もライセンスを確認し、商用利用の可否を把握しておく。